import psycopg2
import sqlite3
#用字符串替换实现的

def trigger_to_function(trigger_name: str, sql: str):
    function_name = trigger_name + "()"
    sql = sql.upper()
    print(sql)
    # dealing with \t and\n
    sql_L = sql.split()
    sql = " ".join(sql_L)

    # locate action
    ll = sql.find("BEGIN") + 6
    rr = sql.find("END") - 2
    action = sql[ll:rr]
    function = "CREATE FUNCTION function_name RETURNS TRIGGER AS $example_table$\n" + "    BEGIN\n" + "        action;\n" + "        RETURN NEW;\n" + "    END;\n" + "$example_table$ LANGUAGE plpgsql;"
    function = function.replace("function_name", function_name)
    function = function.replace("action", action)

    # keywords_needed_to_be_changed
    function = function.replace("DATETIME('NOW')", "CURRENT_TIMESTAMP")
    function = function.replace("json_array", "array")

    print(function)
    return function


def new_trigger(trigger_name: str, sql: str):
    rr = sql.find("BEGIN")
    new_sql = sql[:rr]
    trigger_sql = new_sql + "FOR EACH ROW EXECUTE PROCEDURE " + trigger_name + "()" + ";"
    print(trigger_sql)
    return trigger_sql


conn_opengauss = psycopg2.connect(database="db_huang",
                                  user="faccoco",
                                  password="HYhy8731805",
                                  host="120.46.202.38",
                                  port="26000")
print("Successfully connected to openGauss!")

cursor_openGauss = conn_opengauss.cursor()

try:
    conn = sqlite3.connect('E:\\lessons\\lessons\\2022_summer\\openGauss\\filmdb.sqlite')
except BaseException:
    print("Fail to connect to sqlite database")
    exit(1)

cursor = conn.cursor()
triggers = cursor.execute("select * from sqlite_master where type = 'trigger';")
for row in triggers:
    trigger_name = row[1]
    trigger_sql = row[4]
    function = trigger_to_function(trigger_name, trigger_sql)
    trigger = new_trigger(trigger_name, trigger_sql)
    cursor_openGauss.execute(function)
    cursor_openGauss.execute(trigger)
conn_opengauss.commit()
